(function(h){if("function"===typeof define&&define.amd)define(["jquery"],h);else if("object"===typeof module&&module.exports){var e=require("jquery");module.exports=h(e)}else h(jQuery)})(function(h){if("undefined"===typeof h)throw Error("jQuery.textcomplete requires jQuery");+function(e){var g=1;e.fn.textcomplete=function(b,d){var f=Array.prototype.slice.call(arguments);return this.each(function(){var a=e(this),c=a.data("textComplete");c||(d||(d={}),d._oid=g++,c=new e.fn.textcomplete.Completer(this,
d),a.data("textComplete",c));"string"===typeof b?c&&(f.shift(),c[b].apply(c,f),"destroy"===b&&a.removeData("textComplete")):(e.each(b,function(a){e.each(["header","footer","placement","maxCount"],function(d){a[d]&&(c.option[d]=a[d],console.warn&&console.warn(d+"as a strategy param is deprecated. Use option."),delete a[d])})}),c.register(e.fn.textcomplete.Strategy.parse(b,{el:this,$el:a})))})}}(h);+function(e){function g(d,f){this.$el=e(d);this.id="textcomplete"+b++;this.strategies=[];this.views=[];
this.option=e.extend({},g.defaults,f);if(!(this.$el.is("input[type=text]")||this.$el.is("input[type=search]")||this.$el.is("textarea")||d.isContentEditable)&&"true"!=d.contentEditable)throw Error("textcomplete must be called on a Textarea or a ContentEditable.");if(d===d.ownerDocument.activeElement)this.initialize();else{var a=this;this.$el.one("focus."+this.id,function(){a.initialize()});if((!this.option.adapter||"CKEditor"==this.option.adapter)&&"undefined"!=typeof CKEDITOR&&this.$el.is("textarea"))CKEDITOR.on("instanceReady",
function(c){c.editor.once("focus",function(d){a.$el=e(c.editor.editable().$);a.option.adapter||(a.option.adapter=e.fn.textcomplete.CKEditor,a.option.ckeditor_instance=c.editor);a.initialize()})})}}var b=0;g.defaults={appendTo:"body",className:"",dropdownClassName:"dropdown-menu textcomplete-dropdown",maxCount:10,zIndex:"100",rightEdgeOffset:30};e.extend(g.prototype,{id:null,option:null,strategies:null,adapter:null,dropdown:null,$el:null,$iframe:null,initialize:function(){var d=this.$el.get(0);if(this.$el.prop("ownerDocument")!==
document&&window.frames.length)for(var f=0;f<window.frames.length;f++)if(this.$el.prop("ownerDocument")===window.frames[f].document){this.$iframe=e(window.frames[f].frameElement);break}this.dropdown=new e.fn.textcomplete.Dropdown(d,this,this.option);this.option.adapter?f=this.option.adapter:(f=this.$el.is("textarea")||this.$el.is("input[type=text]")||this.$el.is("input[type=search]")?"number"===typeof d.selectionEnd?"Textarea":"IETextarea":"ContentEditable",f=e.fn.textcomplete[f]);this.adapter=new f(d,
this,this.option)},destroy:function(){this.$el.off("."+this.id);this.adapter&&this.adapter.destroy();this.dropdown&&this.dropdown.destroy();this.$el=this.adapter=this.dropdown=null},deactivate:function(){this.dropdown&&this.dropdown.deactivate()},trigger:function(d,f){this.dropdown||this.initialize();null!=d||(d=this.adapter.getTextFromHeadToCaret());var a=this._extractSearchQuery(d);if(a.length){var c=a[1];f&&this._term===c&&""!==c||(this._term=c,this._search.apply(this,a))}else this._term=null,
this.dropdown.deactivate()},fire:function(d){var f=Array.prototype.slice.call(arguments,1);this.$el.trigger(d,f);return this},register:function(d){Array.prototype.push.apply(this.strategies,d)},select:function(d,f,a){this._term=null;this.adapter.select(d,f,a);this.fire("change").fire("textComplete:select",d,f);this.adapter.focus()},_clearAtNext:!0,_term:null,_extractSearchQuery:function(d){for(var f=0;f<this.strategies.length;f++){var a=this.strategies[f],c=a.context(d);if(c||""===c){var b=e.isFunction(a.match)?
a.match(d):a.match;"[object String]"===Object.prototype.toString.call(c)&&(d=c);if(c=d.match(b))return[a,c[a.index],c]}}return[]},_search:function(d){var f,a;return function(){var c=Array.prototype.slice.call(arguments);if(f)a=c;else{f=!0;var b=this;c.unshift(function k(){if(a){var c=a;a=void 0;c.unshift(k);d.apply(b,c)}else f=!1});d.apply(this,c)}}}(function(d,f,a,c){var b=this;f.search(a,function(c,e){b.dropdown.shown||b.dropdown.activate();b._clearAtNext&&(b.dropdown.clear(),b._clearAtNext=!1);
b.dropdown.setPosition(b.adapter.getCaretPosition());b.dropdown.render(b._zip(c,f,a));e||(d(),b._clearAtNext=!0)},c)}),_zip:function(d,b,a){return e.map(d,function(c){return{value:c,strategy:b,term:a}})}});e.fn.textcomplete.Completer=g}(h);+function(e){function g(a,c,b){this.$el=g.createElement(b);this.completer=c;this.id=c.id+"dropdown";this._data=[];this.$inputEl=e(a);this.option=b;b.listPosition&&(this.setPosition=b.listPosition);b.height&&this.$el.height(b.height);var f=this;e.each("maxCount placement footer header noResultsMessage className".split(" "),
function(a,c){null!=b[c]&&(f[c]=b[c])});this._bindEvents(a);d[this.id]=this}var b=e(window),d={};e(document).on("click",function(a){var c=a.originalEvent&&a.originalEvent.keepTextCompleteDropdown;e.each(d,function(a,b){a!==c&&b.deactivate()})});var f={SKIP_DEFAULT:0,KEY_UP:1,KEY_DOWN:2,KEY_ENTER:3,KEY_PAGEUP:4,KEY_PAGEDOWN:5,KEY_ESCAPE:6};e.extend(g,{createElement:function(a){var c=a.appendTo;c instanceof e||(c=e(c));return e("<ul></ul>").addClass(a.dropdownClassName).attr("id","textcomplete-dropdown-"+
a._oid).css({display:"none",left:0,position:"absolute",zIndex:a.zIndex}).appendTo(c)}});e.extend(g.prototype,{$el:null,$inputEl:null,completer:null,footer:null,header:null,id:null,maxCount:null,placement:"",shown:!1,data:[],className:"",destroy:function(){this.deactivate();this.$el.off("."+this.id);this.$inputEl.off("."+this.id);this.clear();this.$el.remove();this.$el=this.$inputEl=this.completer=null;delete d[this.id]},render:function(a){var c=this._buildContents(a),b=e.map(a,function(a){return a.value});
a.length?(a=a[0].strategy,a.id?this.$el.attr("data-strategy",a.id):this.$el.removeAttr("data-strategy"),this._renderHeader(b),this._renderFooter(b),c&&(this._renderContents(c),this._fitToBottom(),this._fitToRight(),this._activateIndexedItem()),this._setScroll()):this.noResultsMessage?this._renderNoResultsMessage(b):this.shown&&this.deactivate()},setPosition:function(a){var c="absolute";this.$inputEl.add(this.$inputEl.parents()).each(function(){if("absolute"===e(this).css("position"))return!1;if("fixed"===
e(this).css("position"))return a.top-=b.scrollTop(),a.left-=b.scrollLeft(),c="fixed",!1});this.$el.css(this._applyPlacement(a));this.$el.css({position:c});return this},clear:function(){this.$el.html("");this.data=[];this._index=0;this._$header=this._$footer=this._$noResultsMessage=null},activate:function(){this.shown||(this.clear(),this.$el.show(),this.className&&this.$el.addClass(this.className),this.completer.fire("textComplete:show"),this.shown=!0);return this},deactivate:function(){this.shown&&
(this.$el.hide(),this.className&&this.$el.removeClass(this.className),this.completer.fire("textComplete:hide"),this.shown=!1);return this},isUp:function(a){return 38===a.keyCode||a.ctrlKey&&80===a.keyCode},isDown:function(a){return 40===a.keyCode||a.ctrlKey&&78===a.keyCode},isEnter:function(a){return!(a.ctrlKey||a.altKey||a.metaKey||a.shiftKey)&&(13===a.keyCode||9===a.keyCode||!0===this.option.completeOnSpace&&32===a.keyCode)},isPageup:function(a){return 33===a.keyCode},isPagedown:function(a){return 34===
a.keyCode},isEscape:function(a){return 27===a.keyCode},_data:null,_index:null,_$header:null,_$noResultsMessage:null,_$footer:null,_bindEvents:function(){this.$el.on("mousedown."+this.id,".textcomplete-item",e.proxy(this._onClick,this));this.$el.on("touchstart."+this.id,".textcomplete-item",e.proxy(this._onClick,this));this.$el.on("mouseover."+this.id,".textcomplete-item",e.proxy(this._onMouseover,this));this.$inputEl.on("keydown."+this.id,e.proxy(this._onKeydown,this))},_onClick:function(a){var c=
e(a.target);a.preventDefault();a.originalEvent.keepTextCompleteDropdown=this.id;c.hasClass("textcomplete-item")||(c=c.closest(".textcomplete-item"));c=this.data[parseInt(c.data("index"),10)];this.completer.select(c.value,c.strategy,a);var b=this;setTimeout(function(){b.deactivate();"touchstart"===a.type&&b.$inputEl.focus()},0)},_onMouseover:function(a){var c=e(a.target);a.preventDefault();c.hasClass("textcomplete-item")||(c=c.closest(".textcomplete-item"));this._index=parseInt(c.data("index"),10);
this._activateIndexedItem()},_onKeydown:function(a){if(this.shown){var c;e.isFunction(this.option.onKeydown)&&(c=this.option.onKeydown(a,f));null==c&&(c=this._defaultKeydown(a));switch(c){case f.KEY_UP:a.preventDefault();this._up();break;case f.KEY_DOWN:a.preventDefault();this._down();break;case f.KEY_ENTER:a.preventDefault();this._enter(a);break;case f.KEY_PAGEUP:a.preventDefault();this._pageup();break;case f.KEY_PAGEDOWN:a.preventDefault();this._pagedown();break;case f.KEY_ESCAPE:a.preventDefault(),
this.deactivate()}}},_defaultKeydown:function(a){if(this.isUp(a))return f.KEY_UP;if(this.isDown(a))return f.KEY_DOWN;if(this.isEnter(a))return f.KEY_ENTER;if(this.isPageup(a))return f.KEY_PAGEUP;if(this.isPagedown(a))return f.KEY_PAGEDOWN;if(this.isEscape(a))return f.KEY_ESCAPE},_up:function(){0===this._index?this._index=this.data.length-1:--this._index;this._activateIndexedItem();this._setScroll()},_down:function(){this._index=this._index===this.data.length-1?0:this._index+1;this._activateIndexedItem();
this._setScroll()},_enter:function(a){var c=this.data[parseInt(this._getActiveElement().data("index"),10)];this.completer.select(c.value,c.strategy,a);this.deactivate()},_pageup:function(){var a=0,c=this._getActiveElement().position().top-this.$el.innerHeight();this.$el.children().each(function(b){if(e(this).position().top+e(this).outerHeight()>c)return a=b,!1});this._index=a;this._activateIndexedItem();this._setScroll()},_pagedown:function(){var a=this.data.length-1,c=this._getActiveElement().position().top+
this.$el.innerHeight();this.$el.children().each(function(b){if(e(this).position().top>c)return a=b,!1});this._index=a;this._activateIndexedItem();this._setScroll()},_activateIndexedItem:function(){this.$el.find(".textcomplete-item.active").removeClass("active");this._getActiveElement().addClass("active")},_getActiveElement:function(){return this.$el.children(".textcomplete-item:nth("+this._index+")")},_setScroll:function(){var a=this._getActiveElement(),c=a.position().top,a=a.outerHeight(),b=this.$el.innerHeight(),
d=this.$el.scrollTop();0===this._index||this._index==this.data.length-1||0>c?this.$el.scrollTop(c+d):c+a>b&&this.$el.scrollTop(c+a+d-b)},_buildContents:function(a){var c,b,d,f="";for(b=0;b<a.length&&this.data.length!==this.maxCount;b++){c=a[b];a:{d=this.data;var e,g,h=c.strategy.idProperty;for(e=0;e<d.length;e++)if(g=d[e],g.strategy===c.strategy)if(h){if(g.value[h]===c.value[h]){d=!0;break a}}else if(g.value===c.value){d=!0;break a}d=!1}d||(d=this.data.length,this.data.push(c),f+='<li class="textcomplete-item" data-index="'+
d+'"><a>',f+=c.strategy.template(c.value,c.term),f+="</a></li>")}return f},_renderHeader:function(a){this.header&&(this._$header||(this._$header=e('<li class="textcomplete-header"></li>').prependTo(this.$el)),a=e.isFunction(this.header)?this.header(a):this.header,this._$header.html(a))},_renderFooter:function(a){this.footer&&(this._$footer||(this._$footer=e('<li class="textcomplete-footer"></li>').appendTo(this.$el)),a=e.isFunction(this.footer)?this.footer(a):this.footer,this._$footer.html(a))},_renderNoResultsMessage:function(a){this.noResultsMessage&&
(this._$noResultsMessage||(this._$noResultsMessage=e('<li class="textcomplete-no-results-message"></li>').appendTo(this.$el)),a=e.isFunction(this.noResultsMessage)?this.noResultsMessage(a):this.noResultsMessage,this._$noResultsMessage.html(a))},_renderContents:function(a){this._$footer?this._$footer.before(a):this.$el.append(a)},_fitToBottom:function(){var a=b.scrollTop()+b.height(),c=this.$el.height();this.$el.position().top+c>a&&"fixed"!=this.$el.css("position")&&(this.completer.$iframe||this.$el.offset({top:a-
c}))},_fitToRight:function(){for(var a=this.option.rightEdgeOffset,c=this.$el.offset().left,d,f=this.$el.width(),e=b.width()-a;c+f>e;){if(0>c-a){this.$el.offset({left:0});break}this.$el.offset({left:c-a});d=this.$el.offset().left;if(d>=c)break;c=d}},_applyPlacement:function(a){-1!==this.placement.indexOf("top")?a={top:"auto",bottom:this.$el.parent().height()-a.top+a.lineHeight,left:a.left}:(a.bottom="auto",delete a.lineHeight);-1!==this.placement.indexOf("absleft")?a.left=0:-1!==this.placement.indexOf("absright")&&
(a.right=0,a.left="auto");return a}});e.fn.textcomplete.Dropdown=g;e.extend(e.fn.textcomplete,f)}(h);+function(e){function g(d){e.extend(this,d);this.cache&&(this.search=b(this.search))}var b=function(b){var f={};return function(a,c){f[a]?c(f[a]):b.call(this,a,function(b){f[a]=(f[a]||[]).concat(b);c.apply(null,arguments)})}};g.parse=function(b,f){return e.map(b,function(a){a=new g(a);a.el=f.el;a.$el=f.$el;return a})};e.extend(g.prototype,{match:null,replace:null,search:null,id:null,cache:!1,context:function(){return!0},
index:2,template:function(b){return b},idProperty:null});e.fn.textcomplete.Strategy=g}(h);+function(e){function g(){}var b=Date.now||function(){return(new Date).getTime()},d=function(d,a){var c,e,g,h,l,n=function(){var p=b()-h;p<a?c=setTimeout(n,a-p):(c=null,l=d.apply(g,e),g=e=null)};return function(){g=this;e=arguments;h=b();c||(c=setTimeout(n,a));return l}};e.extend(g.prototype,{id:null,completer:null,el:null,$el:null,option:null,initialize:function(b,a,c){this.el=b;this.$el=e(b);this.id=a.id+this.constructor.name;
this.completer=a;this.option=c;this.option.debounce&&(this._onKeyup=d(this._onKeyup,this.option.debounce));this._bindEvents()},destroy:function(){this.$el.off("."+this.id);this.$el=this.el=this.completer=null},select:function(){throw Error("Not implemented");},getCaretPosition:function(){var b=this._getCaretRelativePosition(),a=this.$el.offset(),c=this.option.appendTo;c&&(c instanceof e||(c=e(c)),c=c.offsetParent().offset(),a.top-=c.top,a.left-=c.left);b.top+=a.top;b.left+=a.left;return b},focus:function(){this.$el.focus()},
_bindEvents:function(){this.$el.on("keyup."+this.id,e.proxy(this._onKeyup,this))},_onKeyup:function(b){this._skipSearch(b)||this.completer.trigger(this.getTextFromHeadToCaret(),!0)},_skipSearch:function(b){switch(b.keyCode){case 9:case 13:case 40:case 38:case 27:return!0}if(b.ctrlKey)switch(b.keyCode){case 78:case 80:return!0}}});e.fn.textcomplete.Adapter=g}(h);+function(e){function g(b,d,e){this.initialize(b,d,e)}e.extend(g.prototype,e.fn.textcomplete.Adapter.prototype,{select:function(b,d,f){var a=
this.getTextFromHeadToCaret(),c=this.el.value.substring(this.el.selectionEnd);b=d.replace(b,f);"undefined"!==typeof b&&(e.isArray(b)&&(c=b[1]+c,b=b[0]),d=e.isFunction(d.match)?d.match(a):d.match,a=a.replace(d,b),this.$el.val(a+c),this.el.selectionStart=this.el.selectionEnd=a.length)},getTextFromHeadToCaret:function(){return this.el.value.substring(0,this.el.selectionEnd)},_getCaretRelativePosition:function(){var b=e.fn.textcomplete.getCaretCoordinates(this.el,this.el.selectionStart);return{top:b.top+
this._calculateLineHeight()-this.$el.scrollTop(),left:b.left-this.$el.scrollLeft(),lineHeight:this._calculateLineHeight()}},_calculateLineHeight:function(){var b=parseInt(this.$el.css("line-height"),10);if(isNaN(b)){var d=this.el.parentNode,e=document.createElement(this.el.nodeName),b=this.el.style;e.setAttribute("style","margin:0px;padding:0px;font-family:"+b.fontFamily+";font-size:"+b.fontSize);e.innerHTML="test";d.appendChild(e);b=e.clientHeight;d.removeChild(e)}return b}});e.fn.textcomplete.Textarea=
g}(h);+function(e){function g(b,d,f){this.initialize(b,d,f);e("<span>\u5436</span>").css({position:"absolute",top:-9999,left:-9999}).insertBefore(b)}e.extend(g.prototype,e.fn.textcomplete.Textarea.prototype,{select:function(b,d,f){var a=this.getTextFromHeadToCaret(),c=this.el.value.substring(a.length);b=d.replace(b,f);"undefined"!==typeof b&&(e.isArray(b)&&(c=b[1]+c,b=b[0]),d=e.isFunction(d.match)?d.match(a):d.match,a=a.replace(d,b),this.$el.val(a+c),this.el.focus(),c=this.el.createTextRange(),c.collapse(!0),
c.moveEnd("character",a.length),c.moveStart("character",a.length),c.select())},getTextFromHeadToCaret:function(){this.el.focus();var b=document.selection.createRange();b.moveStart("character",-this.el.value.length);b=b.text.split("\u5436");return 1===b.length?b[0]:b[1]}});e.fn.textcomplete.IETextarea=g}(h);+function(e){function g(b,d,e){this.initialize(b,d,e)}e.extend(g.prototype,e.fn.textcomplete.Adapter.prototype,{select:function(b,d,f){var a=this.getTextFromHeadToCaret(),c=this.el.ownerDocument.getSelection(),
g=c.getRangeAt(0),h=g.cloneRange();h.selectNodeContents(g.startContainer);h=h.toString().substring(g.startOffset);b=d.replace(b,f);if("undefined"!==typeof b){e.isArray(b)&&(h=b[1]+h,b=b[0]);d=e.isFunction(d.match)?d.match(a):d.match;a=a.replace(d,b).replace(/ $/,"&nbsp");g.selectNodeContents(g.startContainer);g.deleteContents();d=this.el.ownerDocument.createElement("div");d.innerHTML=a;a=this.el.ownerDocument.createElement("div");a.innerHTML=h;for(var h=this.el.ownerDocument.createDocumentFragment(),
k;b=d.firstChild;)k=h.appendChild(b);for(;b=a.firstChild;)h.appendChild(b);g.insertNode(h);g.setStartAfter(k);g.collapse(!0);c.removeAllRanges();c.addRange(g)}},_getCaretRelativePosition:function(){var b=this.el.ownerDocument.getSelection().getRangeAt(0).cloneRange(),d=this.el.ownerDocument.createElement("span");b.insertNode(d);b.selectNodeContents(d);b.deleteContents();b=e(d);d=b.offset();d.left-=this.$el.offset().left;d.top+=b.height()-this.$el.offset().top;d.lineHeight=b.height();if(this.completer.$iframe){var f=
this.completer.$iframe.offset();d.top+=f.top;d.left+=f.left;d.top-=this.$el.scrollTop()}b.remove();return d},getTextFromHeadToCaret:function(){var b=this.el.ownerDocument.getSelection().getRangeAt(0),d=b.cloneRange();d.selectNodeContents(b.startContainer);return d.toString().substring(0,b.startOffset)}});e.fn.textcomplete.ContentEditable=g}(h);+function(e){function g(b,d,e){this.initialize(b,d,e)}e.extend(g.prototype,e.fn.textcomplete.ContentEditable.prototype,{_bindEvents:function(){var b=this;this.option.ckeditor_instance.on("key",
function(d){d=d.data;b._onKeyup(d);if(b.completer.dropdown.shown&&b._skipSearch(d))return!1},null,null,1);this.$el.on("keyup."+this.id,e.proxy(this._onKeyup,this))}});e.fn.textcomplete.CKEditor=g}(h);(function(e){var g="direction boxSizing width height overflowX overflowY borderTopWidth borderRightWidth borderBottomWidth borderLeftWidth borderStyle paddingTop paddingRight paddingBottom paddingLeft fontStyle fontVariant fontWeight fontStretch fontSize fontSizeAdjust lineHeight fontFamily textAlign textTransform textIndent textDecoration letterSpacing wordSpacing tabSize MozTabSize".split(" "),
b="undefined"!==typeof window,d=b&&null!=window.mozInnerScreenX;e.fn.textcomplete.getCaretCoordinates=function(e,a,c){if(!b)throw Error("textarea-caret-position#getCaretCoordinates should only be called in a browser");if(c=c&&c.debug||!1){var h=document.querySelector("#input-textarea-caret-position-mirror-div");h&&h.parentNode.removeChild(h)}h=document.createElement("div");h.id="input-textarea-caret-position-mirror-div";document.body.appendChild(h);var m=h.style,k=window.getComputedStyle?getComputedStyle(e):
e.currentStyle;m.whiteSpace="pre-wrap";"INPUT"!==e.nodeName&&(m.wordWrap="break-word");m.position="absolute";c||(m.visibility="hidden");g.forEach(function(a){m[a]=k[a]});d?e.scrollHeight>parseInt(k.height)&&(m.overflowY="scroll"):m.overflow="hidden";h.textContent=e.value.substring(0,a);"INPUT"===e.nodeName&&(h.textContent=h.textContent.replace(/\s/g,"\u00a0"));var l=document.createElement("span");l.textContent=e.value.substring(a)||".";h.appendChild(l);e={top:l.offsetTop+parseInt(k.borderTopWidth),
left:l.offsetLeft+parseInt(k.borderLeftWidth)};c?l.style.backgroundColor="#aaa":document.body.removeChild(h);return e}})(h);return h});